<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Produk - RHF GAMES</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <img id="bannerImg" src="" alt="Banner">
        <h1 id="pageTitle">Top Up</h1>

        <h2>1. Masukkan Data Akun</h1>
        <div id="inputFields"></div>
        <p id="helpText"></p>

        <h2>2. Pilih Nominal</h2>
        <div class="options-grid" id="optionsGrid"></div>

        <button id="proceedBtn" disabled>Lanjut ke Pembayaran</button>
    </div>

    <script src="firebase.js"></script>
    <script src="auth.js"></script>
    <script src="utils.js"></script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        let selectedOption = null;
        let inputValues = {};

        db.collection("products").doc(productId).get().then(doc => {
            if (!doc.exists) {
                showToast("Produk tidak ditemukan!", 'error');
                return;
            }
            const p = doc.data();
            document.getElementById('bannerImg').src = p.image;
            document.getElementById('pageTitle').textContent = "Top Up " + p.title;
            document.getElementById('helpText').textContent = p.helpText || "Masukkan data akun dengan benar.";

            // Render input fields fleksibel
            const inputContainer = document.getElementById('inputFields');
            (p.inputFields || []).forEach(field => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label>${field.label}</label>
                    <input type="text" placeholder="\( {field.placeholder}" data-key=" \){field.label}">
                `;
                inputContainer.appendChild(div);
            });
            inputContainer.addEventListener('input', e => {
                if (e.target.tagName === 'INPUT') {
                    inputValues[e.target.dataset.key] = e.target.value;
                }
                checkProceedButton();
            });

            // Render nominal
            const grid = document.getElementById('optionsGrid');
            (p.rechargeOptions || []).forEach(opt => {
                const div = document.createElement('div');
                div.className = `option ${opt.bonus ? 'bonus' : ''}`;
                div.innerHTML = `
                    <div class="amount">${opt.amount}</div>
                    <div class="price">${formatRupiah(opt.price)}</div>
                `;
                div.onclick = () => {
                    document.querySelectorAll('.option').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                    selectedOption = opt;
                    checkProceedButton();
                };
                grid.appendChild(div);
            });
        });

        function checkProceedButton() {
            const allFilled = Object.values(inputValues).every(v => v.trim() !== '');
            document.getElementById('proceedBtn').disabled = !(allFilled && selectedOption);
        }

        document.getElementById('proceedBtn').onclick = () => {
            auth.onAuthStateChanged(user => {
                if (!user) {
                    showToast("Login dulu!", 'error');
                    return;
                }
                addToCart(productId, {title: document.getElementById('pageTitle').textContent}, selectedOption, inputValues);
            });
        };
    </script>
</body>
</html>
