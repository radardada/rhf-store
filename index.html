<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RHF Game Store</title>

<style>
body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:#020617;
  color:#fff;
}

header{
  padding:16px;
  font-size:20px;
  font-weight:bold;
}

.container{padding:16px}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
  gap:14px;
}

.card{
  background:#020617;
  border:1px solid #1e293b;
  border-radius:14px;
  overflow:hidden;
}

.card img{
  width:100%;
  height:120px;
  object-fit:cover;
}

.card .c{
  padding:10px;
}

.card h4{
  margin:0;
  font-size:14px;
}

.price{
  color:#22c55e;
  font-weight:bold;
  margin-top:6px;
}

button{
  width:100%;
  margin-top:8px;
  padding:8px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
}

.buy{background:#22c55e;color:#000}
.gray{background:#334155;color:#fff}

/* LOGIN BUTTON */
#loginBtn{
  position:fixed;
  top:12px;
  right:14px;
  background:#22c55e;
  color:#000;
  padding:6px 14px;
  border-radius:999px;
  font-weight:bold;
  cursor:pointer;
  z-index:999;
}

/* LOGIN MODAL */
.login-modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  backdrop-filter:blur(6px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}

.login-card{
  background:#020617;
  border:1px solid #1e293b;
  border-radius:18px;
  width:90%;
  max-width:360px;
  padding:24px;
  text-align:center;
}

.login-card input{
  width:100%;
  padding:12px;
  margin-top:10px;
  background:#020617;
  border:1px solid #1e293b;
  border-radius:10px;
  color:#fff;
}

.login-card button{
  margin-top:12px;
}

.close{
  float:right;
  cursor:pointer;
  font-size:20px;
}
</style>
</head>

<body>

<header>RHF Game Store</header>
<div id="loginBtn" onclick="openLogin()">Login</div>

<div class="container">
  <div class="grid" id="items"></div>
</div>

<!-- LOGIN MODAL -->
<div id="loginModal" class="login-modal">
  <div class="login-card">
    <span class="close" onclick="closeLogin()">Ã—</span>
    <h3>LOGIN MEMBER</h3>
    <input id="loginUser" placeholder="Username">
    <input id="loginPass" type="password" placeholder="Password">
    <button class="buy" onclick="login()">Masuk</button>
    <button class="gray" onclick="regWa()">Registrasi via WhatsApp</button>
  </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAyHSaALeuwibcF22VNL_6WDlcZepcDB3A",
  authDomain: "rhf-gamestore.firebaseapp.com",
  databaseURL: "https://rhf-gamestore-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "rhf-gamestore",
  storageBucket: "rhf-gamestore.firebasestorage.app",
  messagingSenderId: "52065906934",
  appId: "1:52065906934:web:c15f0eff91cc937f787cd7"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const itemsRef = db.ref("items");
const vouchersRef = db.ref("vouchers");
const usersRef = db.ref("users");
const logsRef = db.ref("logs");

let currentUser = null;

/* ================= LOAD ITEMS ================= */
itemsRef.on("value",snap=>{
  items.innerHTML="";
  snap.forEach(c=>{
    const d=c.val();
    items.innerHTML+=`
      <div class="card">
        <img src="${d.img}">
        <div class="c">
          <h4>${d.name}</h4>
          <div class="price">Rp ${d.price.toLocaleString("id-ID")}</div>
          <button class="buy" onclick="buy('${c.key}')">Beli</button>
        </div>
      </div>
    `;
  });
});

/* ================= BUY ================= */
function buy(id){
  const code = prompt("Masukkan kode voucher (kosongkan jika tidak ada):");

  if(code && !currentUser){
    alert("Login dulu untuk pakai voucher");
    return;
  }

  if(!code){
    sendWa("Pembelian tanpa voucher",id,0);
    return;
  }

  vouchersRef.child(code).once("value",s=>{
    if(!s.exists()) return alert("Voucher tidak valid");
    const v=s.val();

    if(!v.active || v.used>=v.max) return alert("Voucher tidak aktif");

    usersRef.child(currentUser).once("value",u=>{
      if(u.val().usedVoucher) return alert("Voucher sudah dipakai");

      const discount=v.disc;
      v.used++;

      vouchersRef.child(code).update({used:v.used});
      usersRef.child(currentUser).update({usedVoucher:true});

      logsRef.push({
        user:currentUser,
        voucher:code,
        disc:discount,
        time:new Date().toLocaleString("id-ID")
      });

      sendWa("Pakai voucher "+code,id,discount);
    });
  });
}

function sendWa(info,id,disc){
  itemsRef.child(id).once("value",s=>{
    const d=s.val();
    let finalPrice=d.price - (d.price*disc/100);
    const msg=`RHF ORDER
Item: ${d.name}
Harga: Rp ${d.price.toLocaleString("id-ID")}
Diskon: ${disc}%
Total: Rp ${finalPrice.toLocaleString("id-ID")}`;

    window.open(
      "https://wa.me/6285135993982?text="+encodeURIComponent(msg),
      "_blank"
    );
  });
}

/* ================= LOGIN ================= */
function openLogin(){loginModal.style.display="flex"}
function closeLogin(){loginModal.style.display="none"}

function login(){
  const u=loginUser.value.trim();
  const p=loginPass.value.trim();
  if(!u||!p) return alert("Lengkapi login");

  usersRef.child(u).once("value",s=>{
    if(!s.exists()) return alert("User tidak ditemukan");
    const d=s.val();
    if(d.pass!==p) return alert("Password salah");
    if(d.status!=="aktif") return alert("Akun diblokir");

    currentUser=u;
    localStorage.setItem("RHF_USER",u);
    closeLogin();
    loginBtn.style.display="none";
  });
}

function regWa(){
  window.open(
    "https://wa.me/6285135993982?text=REGISTER%20RHF",
    "_blank"
  );
}

window.onload=()=>{
  const u=localStorage.getItem("RHF_USER");
  if(!u) return;
  usersRef.child(u).once("value",s=>{
    if(s.exists()&&s.val().status==="aktif"){
      currentUser=u;
      loginBtn.style.display="none";
    }
  });
};
</script>

</body>
</html>
