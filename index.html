<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RHF Game Store</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, get, set, push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* ===== FIREBASE ===== */
const firebaseConfig = {
  apiKey: "AIzaSyAyHSaALeuwibcF22VNL_6WDlcZepcDB3A",
  authDomain: "rhf-gamestore.firebaseapp.com",
  databaseURL: "https://rhf-gamestore-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "rhf-gamestore",
  storageBucket: "rhf-gamestore.firebasestorage.app",
  messagingSenderId: "52065906934",
  appId: "1:52065906934:web:c15f0eff91cc937f787cd7"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ===== UTIL ===== */
async function hash(t){
  const e=new TextEncoder().encode(t);
  const b=await crypto.subtle.digest("SHA-256",e);
  return Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,"0")).join("");
}

let user = localStorage.getItem("user");

/* ===== LOGIN & REGIS ===== */
window.auth = async(mode)=>{
  const u = username.value.trim();
  const p = password.value.trim();
  if(u.length<4||p.length<6) return alert("Username / Password terlalu pendek");

  const r = ref(db,'users/'+u);
  const s = await get(r);
  const h = await hash(p);

  if(mode==="login"){
    if(!s.exists() || s.val().passwordHash!==h) return alert("Login gagal");
  }else{
    if(s.exists()) return alert("Username sudah dipakai");
    await set(r,{passwordHash:h,saldo:0,created:Date.now()});
  }

  localStorage.setItem("user",u);
  location.reload();
};

/* ===== LOAD USER ===== */
if(user){
  authBox.style.display="none";
  appBox.style.display="block";
  onValue(ref(db,'users/'+user+'/saldo'),s=>saldo.innerText=s.val()||0);
}

/* ===== PRODUK ===== */
onValue(ref(db,'products'),snap=>{
  grid.innerHTML='';
  snap.forEach(c=>{
    const p=c.val();
    if(!p.active) return;
    grid.innerHTML+=`
    <div class="card">
      <img src="${p.image}">
      <b>${p.name}</b>
      <small>${p.game}</small>
      <span>Rp ${p.price}</span>
    </div>`;
  });
});

/* ===== CS ===== */
window.sendCS=()=>{
  if(!csMsg.value) return;
  push(ref(db,'cs'),{user,msg:csMsg.value,time:Date.now()});
  csMsg.value='';
};

/* ===== TOP UP ===== */
window.topup=()=>{
  const j = topupAmount.value;
  const b = topupProof.value;
  if(!j||!b) return alert("Lengkapi data");
  push(ref(db,'topup'),{user,jumlah:j,bukti:b,status:"pending"});
  alert("Menunggu konfirmasi admin");
};
</script>

<style>
*{box-sizing:border-box;font-family:Roboto}
body{margin:0;background:#0f1115;color:#fff}
header{padding:14px;background:#151821}
#grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:10px}
.card{background:#1b1f2a;padding:10px;border-radius:14px}
.card img{width:100%;height:100px;object-fit:cover;border-radius:10px}
nav{position:fixed;bottom:0;left:0;right:0;background:#151821;display:flex;justify-content:space-around;padding:10px}
nav div{color:#aaa}
nav div.active{color:#4cafef}
.box{padding:14px}
input,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:none}
button{background:#4cafef;color:#000;font-weight:700}
</style>
</head>

<body>

<!-- AUTH -->
<div id="authBox" class="box">
  <h2>Login / Registrasi</h2>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button onclick="auth('login')">Login</button>
  <button onclick="auth('regis')">Registrasi</button>
</div>

<!-- APP -->
<div id="appBox" style="display:none">
<header>
  <b>RHF Game Store</b><br>
  Saldo: Rp <span id="saldo">0</span>
</header>

<div id="grid"></div>

<div class="box">
  <h3>Top Up</h3>
  <input id="topupAmount" placeholder="Jumlah">
  <input id="topupProof" placeholder="Link bukti transfer">
  <button onclick="topup()">Kirim</button>

  <h3>Customer Service</h3>
  <input id="csMsg" placeholder="Tulis pesan">
  <button onclick="sendCS()">Kirim</button>
</div>

<nav>
  <div class="active">Home</div>
  <div>Promo</div>
  <div>CS</div>
  <div onclick="localStorage.clear();location.reload()">Akun</div>
</nav>
</div>

</body>
</html>
