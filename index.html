<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RHF Game Store</title>

<style>
body{background:#020617;color:#fff;font-family:Arial;margin:0;padding:14px}
.box{background:#020617;border:1px solid #1e293b;border-radius:14px;padding:14px;margin-bottom:14px}
input,button{width:100%;padding:10px;margin-top:8px;border-radius:10px;border:none}
button{font-weight:bold;cursor:pointer}
.green{background:#22c55e;color:#000}
.gray{background:#334155;color:#fff}
.red{background:#ef4444;color:#fff}
.item{border-bottom:1px solid #1e293b;padding:10px 0}
small{color:#94a3b8}
.hidden{display:none}
</style>
</head>

<body>

<h2>RHF Game Store</h2>

<!-- ================= LOGIN ================= -->
<div id="loginBox" class="box">
  <h3>Login Member</h3>
  <input id="loginUser" placeholder="Username">
  <input id="loginPass" type="password" placeholder="Password">
  <button class="green" onclick="login()">Login</button>

  <hr>
  <small>Belum punya akun?</small>
  <button class="gray" onclick="regWa()">Registrasi via WhatsApp</button>
</div>

<!-- ================= INFO USER ================= -->
<div id="userInfo" class="box hidden">
  Login sebagai: <b id="userName"></b>
  <button class="red" onclick="logout()">Logout</button>
</div>

<!-- ================= ITEM ================= -->
<div class="box">
  <h3>Daftar Item</h3>
  <div id="items"></div>
</div>

<!-- ================= BELI ================= -->
<div id="buyBox" class="box hidden">
  <h3>Konfirmasi Pembelian</h3>

  <div id="buyDetail"></div>

  <input id="voucherInput" placeholder="Kode Voucher (login)">
  <button class="gray" onclick="applyVoucher()">Gunakan Voucher</button>

  <div id="priceInfo"></div>

  <button class="green" onclick="sendOrder()">Kirim Pesanan ke WhatsApp</button>
  <button class="red" onclick="closeBuy()">Batal</button>
</div>

<!-- ================= FIREBASE ================= -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAyHSaALeuwibcF22VNL_6WDlcZepcDB3A",
  authDomain: "rhf-gamestore.firebaseapp.com",
  databaseURL: "https://rhf-gamestore-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "rhf-gamestore",
  storageBucket: "rhf-gamestore.firebasestorage.app",
  messagingSenderId: "52065906934",
  appId: "1:52065906934:web:c15f0eff91cc937f787cd7"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = null;
let selectedItem = null;
let finalPrice = 0;
let usedVoucherCode = null;

/* ================= LOGIN ================= */
function login(){
  const u = loginUser.value.trim();
  const p = loginPass.value.trim();
  if(!u || !p) return alert("Lengkapi login");

  db.ref("users/"+u).once("value",s=>{
    if(!s.exists()) return alert("Akun tidak ditemukan");
    const d=s.val();
    if(d.pass!==p) return alert("Password salah");
    if(d.status!=="aktif") return alert("Akun diblokir");

    currentUser=u;
    localStorage.setItem("RHF_USER",u);
    userName.innerText=u;
    loginBox.classList.add("hidden");
    userInfo.classList.remove("hidden");
  });
}

function logout(){
  localStorage.removeItem("RHF_USER");
  location.reload();
}

function regWa(){
  window.open(
    "https://wa.me/6285135993982?text=REGISTER%20RHF",
    "_blank"
  );
}

/* ================= AUTO LOGIN ================= */
window.onload=()=>{
  const u=localStorage.getItem("RHF_USER");
  if(!u) return;
  db.ref("users/"+u).once("value",s=>{
    if(s.exists() && s.val().status==="aktif"){
      currentUser=u;
      userName.innerText=u;
      loginBox.classList.add("hidden");
      userInfo.classList.remove("hidden");
    }
  });
};

/* ================= ITEM ================= */
db.ref("items").on("value",s=>{
  items.innerHTML="";
  s.forEach(c=>{
    const d=c.val();
    items.innerHTML+=`
      <div class="item">
        <b>${d.game}</b><br>
        ${d.name}<br>
        Rp ${d.price.toLocaleString("id-ID")}<br>
        <button class="green" onclick='buyItem(${JSON.stringify(d)})'>Beli</button>
      </div>`;
  });
});

/* ================= BELI ================= */
function buyItem(d){
  selectedItem=d;
  finalPrice=d.price;
  usedVoucherCode=null;

  buyDetail.innerHTML=`
    <b>${d.game}</b><br>
    ${d.name}<br>
    Harga: Rp ${d.price.toLocaleString("id-ID")}
  `;
  priceInfo.innerHTML="";
  buyBox.classList.remove("hidden");
}

function closeBuy(){
  buyBox.classList.add("hidden");
}

/* ================= VOUCHER ================= */
function applyVoucher(){
  if(!currentUser) return alert("Login dulu");

  const code=voucherInput.value.trim();
  if(!code) return;

  db.ref("users/"+currentUser+"/usedVoucher").once("value",u=>{
    if(u.val()) return alert("Voucher sudah dipakai");
  });

  db.ref("vouchers/"+code).once("value",s=>{
    if(!s.exists()) return alert("Voucher tidak valid");

    const v=s.val();
    if(!v.active) return alert("Voucher tidak aktif");
    if(v.used>=v.max) return alert("Voucher habis");

    const disc=Math.floor(selectedItem.price*(v.disc/100));
    finalPrice=selectedItem.price-disc;
    usedVoucherCode=code;

    priceInfo.innerHTML=`
      Diskon: ${v.disc}%<br>
      Harga Akhir: <b>Rp ${finalPrice.toLocaleString("id-ID")}</b>
    `;
  });
}

/* ================= ORDER ================= */
function sendOrder(){
  const code="RHF-"+Date.now();
  let text=
`PESANAN RHF
Kode: ${code}
Item: ${selectedItem.name}
Harga: Rp ${finalPrice.toLocaleString("id-ID")}
User: ${currentUser||"Guest"}
Voucher: ${usedVoucherCode||"-"}`;

  db.ref("logs").push({
    user:currentUser||"guest",
    item:selectedItem.name,
    price:finalPrice,
    voucher:usedVoucherCode||"",
    code:code,
    time:new Date().toLocaleString()
  });

  if(currentUser && usedVoucherCode){
    db.ref("users/"+currentUser).update({usedVoucher:true});
    db.ref("vouchers/"+usedVoucherCode).transaction(v=>{
      v.used++; return v;
    });
  }

  window.open(
    "https://wa.me/6285135993982?text="+encodeURIComponent(text),
    "_blank"
  );

  closeBuy();
}
</script>

</body>
</html>
